<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>üîß Update Ticket</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 30px;
      max-width: 600px;
      margin: auto;
      position: relative;
      background: #f8f9fa;
    }
    h1 { margin-bottom: 20px; }
    label { display: block; margin-top: 15px; font-weight: bold; }
    input, select, textarea {
      width: 100%;
      padding: 8px;
      margin-top: 5px;
      border-radius: 4px;
      border: 1px solid #ccc;
    }
    button {
      margin-top: 20px;
      padding: 10px;
      width: 100%;
      background-color: #198754;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    button:hover { background-color: #157347; }
    .home-btn {
      position: absolute;
      top: 20px;
      right: 130px;
      background: #0d6efd;
      color: white;
      padding: 8px 14px;
      border-radius: 5px;
      text-decoration: none;
    }
    .home-btn:hover { background: #0b5ed7; }
    .logout {
      position: absolute;
      top: 20px;
      right: 30px;
      background: #dc3545;
      color: white;
      padding: 8px 14px;
      border-radius: 5px;
      text-decoration: none;
    }
    .logout:hover { background: #c82333; }
  </style>
</head>
<body>
  <a class="home-btn" href="/dashboard.html">üè† Home</a>
  <a class="logout" href="/logout">üö™ Logout</a>

  <h1>üîß Update Ticket</h1>

  <form id="updateForm">
    <p><strong>Ticket ID:</strong> <span id="ticketIdText"></span></p>
    <p><strong>Item:</strong> <span id="itemName"></span></p>
    <p><strong>Quantity:</strong> <span id="quantity"></span></p>
    <p><strong>From:</strong> <span id="fromWarehouse"></span></p>
    <p><strong>To:</strong> <span id="toWarehouse"></span></p>

    <label>Status:</label>
    <select id="status">
      <option value="Pending">Pending</option>
      <option value="Delayed">Delayed</option>
      <option value="Closed">Closed</option>
    </select>

    <label>Expected Ready:</label>
    <input type="date" id="expected_ready" />

    <label>Actual Ready:</label>
    <input type="date" id="actual_ready" />

    <label>Delay Reason / Notes:</label>
    <textarea id="delay_reason" rows="4"></textarea>

    <button type="submit">üíæ Save Changes</button>
  </form>

  <script>
    const urlParams = new URLSearchParams(window.location.search);
    const ticketId = urlParams.get("id");

    async function loadTicket() {
      const res = await fetch("/tickets");
      const tickets = await res.json();
      const ticket = tickets.find(t => Number(t.id) === Number(ticketId));
      if (!ticket) {
        alert("‚ùå Ticket not found");
        return;
      }

      document.getElementById("ticketIdText").textContent = ticket.id;
      document.getElementById("itemName").textContent = ticket.name || ticket.item_id;
      document.getElementById("quantity").textContent = ticket.quantity;
      document.getElementById("fromWarehouse").textContent = ticket.from_warehouse;
      document.getElementById("toWarehouse").textContent = ticket.to_warehouse;
      document.getElementById("status").value = ticket.status || "Pending";
      document.getElementById("expected_ready").value = ticket.expected_ready || "";
      document.getElementById("actual_ready").value = ticket.actual_ready || "";
      document.getElementById("delay_reason").value = ticket.delay_reason || "";
    }

    document.getElementById("updateForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const status = document.getElementById("status").value;
      const expected_ready = document.getElementById("expected_ready").value;
      const actual_ready = document.getElementById("actual_ready").value;
      const delay_reason = document.getElementById("delay_reason").value;

      const res = await fetch("/update-ticket-status", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ id: ticketId, status, expected_ready, actual_ready, delay_reason })
      });
      const result = await res.json();
      if (result.success) {
        alert("‚úÖ Ticket updated successfully!");
        window.location.href = "/ticket-view.html";
      } else {
        alert("‚ùå " + result.message);
      }
    });

    loadTicket();
  </script>
</body>
</html>
