<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>🎫 Ticket View</title>
  <style>
    <body>
  <h2>📋 All Tickets Overview</h2>

  <!-- 🔽 Filter Dropdown -->
  <label for="statusFilter">Filter by Status:</label>
  <select id="statusFilter">
    <option value="all">All</option>
    <option value="Pending">Pending</option>
    <option value="Closed">Closed</option>
    <option value="In Progress">In Progress</option>
  </select>

  <table id="ticketTable">
    <thead>
      <tr>
        <th>ID</th>
        <th>From</th>
        <th>To</th>
        <th>Item</th>
        <th>Qty</th>
        <th>Status</th>
        <th>Expected Ready</th>
        <th>Actual Ready</th>
        <th>Delay Reason</th>
        <th>🕒 Updated</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    document.addEventListener('DOMContentLoaded', async () => {
      try {
        const res = await fetch('/tickets');
        const data = await res.json();

        const tableBody = document.querySelector("#ticketTable tbody");
        const statusFilter = document.getElementById("statusFilter");

        function renderTable(tickets) {
          tableBody.innerHTML = "";
          tickets.forEach(ticket => {
            const row = document.createElement("tr");
            row.innerHTML = `
              <td>${ticket.id}</td>
              <td>${ticket.from_warehouse}</td>
              <td>${ticket.to_warehouse}</td>
              <td>${ticket.name}</td>
              <td>${ticket.quantity}</td>
              <td>${ticket.status}</td>
              <td>${ticket.expected_ready || "-"}</td>
              <td>${ticket.actual_ready || "-"}</td>
              <td>${ticket.delay_reason || "-"}</td>
              <td>${ticket.updated_at ? new Date(ticket.updated_at).toLocaleString() : "-"}</td>
            `;
            tableBody.appendChild(row);
          });
        }

        // Initial render
        renderTable(data);

        // Filter by status
        statusFilter.addEventListener("change", () => {
          const selected = statusFilter.value;
          const filtered = selected === "all"
            ? data
            : data.filter(t => t.status === selected);
          renderTable(filtered);
        });
      } catch (err) {
        console.error("❌ Failed to load tickets:", err);
      }
    });
  </script>
</body>
</html>
