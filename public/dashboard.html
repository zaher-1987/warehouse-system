<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>üì¶ Warehouse Inventory Dashboard</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 30px;
      background: #f4f6f8;
      position: relative;
    }
    h2 {
      margin-bottom: 10px;
    }
    #userWarehouseInfo {
      margin-bottom: 20px;
      font-style: italic;
    }
    select, input[type="text"] {
      padding: 6px 10px;
      margin-right: 10px;
    }
    button {
      padding: 8px 16px;
      background: #198754;
      color: white;
      border: none;
      cursor: pointer;
      border-radius: 4px;
      margin-bottom: 20px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      background: white;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 10px;
      text-align: left;
    }
    th {
      background: #f2f2f2;
      cursor: pointer;
    }
    .green { background-color: #d4edda; color: #155724; }
    .orange { background-color: #fff3cd; color: #856404; }
    .red { background-color: #f8d7da; color: #721c24; }
    .unknown { background-color: #e2e3e5; color: #6c757d; }
    .modal {
      display: none;
      position: fixed;
      z-index: 999;
      left: 0; top: 0;
      width: 100%; height: 100%;
      background-color: rgba(0,0,0,0.5);
    }
    .modal-content {
      background: white;
      margin: 10% auto;
      padding: 20px;
      border-radius: 8px;
      width: 90%;
      max-width: 900px;
      height: 600px;
      position: relative;
    }
    .close {
      position: absolute;
      top: 10px; right: 15px;
      font-size: 24px;
      cursor: pointer;
    }
    iframe {
      width: 100%;
      height: 100%;
      border: none;
    }
    .logout {
      position: absolute;
      top: 20px;
      right: 30px;
      background: #dc3545;
      color: white;
      padding: 8px 14px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      text-decoration: none;
    }
    .ticket-button {
      position: absolute;
      top: 20px;
      right: 130px;
      background: #0d6efd;
      color: white;
      padding: 8px 14px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      text-decoration: none;
    }
  </style>
</head>
<body>
  <a class="logout" href="/logout">üö™ Logout</a>
  <a class="ticket-button" id="viewTicketsBtn" href="#" style="display:none;">üé´ View Tickets</a>
  <h2>üì¶ Warehouse Inventory Dashboard</h2>
  <p id="userWarehouseInfo">Checking session...</p>

  <label for="warehouseFilter">Filter by Warehouse:</label>
  <select id="warehouseFilter">
    <option value="">All</option>
  </select>

  <button onclick="exportInventory()">üìÅ Export to Excel</button>
  <button onclick="openChartModal()">üìä View Charts</button>
  <button id="editToggle" style="display:none;" onclick="toggleEditMode()">‚úèÔ∏è Enable Edit Mode</button>
  <button id="createWarehouseBtn" style="display:none;" onclick="showCreateWarehouse()">‚ûï Create Warehouse</button>

  <div id="createWarehouseContainer" style="display:none; margin-bottom:20px;">
    <h4>Create New Warehouse</h4>
    <input type="text" id="newWarehouseInput" placeholder="Enter warehouse name">
    <button onclick="saveWarehouse()">‚úÖ Save</button>
  </div>

  <table id="inventoryTable">
    <thead>
      <tr>
        <th>Warehouse</th>
        <th>Item ID</th>
        <th>Item Name</th>
        <th>Quantity</th>
        <th>Status</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <div id="chartModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeChartModal()">√ó</span>
      <iframe src="warehouse-charts.html"></iframe>
    </div>
  </div>

  <script>
    let editMode = false;
    let userRole = 'staff';
    let assignedWarehouse = '';

    async function checkSession() {
      const res = await fetch('/session-status');
      const data = await res.json();
      if (!data.loggedIn) {
        window.location.href = '/login.html';
        return;
      }

      userRole = data.user.role;
      assignedWarehouse = data.user.warehouse_name || '';

      document.getElementById('userWarehouseInfo').textContent =
        userRole === 'admin'
          ? 'Logged in as Admin (all warehouses)'
          : `Logged in as ${userRole.charAt(0).toUpperCase() + userRole.slice(1)} - Warehouse: ${assignedWarehouse}`;

      // üé´ View Tickets logic for each role
      const viewBtn = document.getElementById('viewTicketsBtn');
      if (userRole === 'production') {
        viewBtn.href = '/production-view.html';
        viewBtn.style.display = 'inline-block';
      } else if (userRole === 'admin') {
        viewBtn.href = '/ticket-view.html';
        viewBtn.style.display = 'inline-block';
      }

      if (userRole === 'admin') {
        document.getElementById('editToggle').style.display = 'inline-block';
        document.getElementById('createWarehouseBtn').style.display = 'inline-block';
      }

      if (userRole === 'staff') {
        document.getElementById('warehouseFilter').style.display = 'none';
      }

      loadInventory();
    }

    function toggleEditMode() {
      if (userRole !== 'admin') {
        alert('‚ùå Only admin can edit items.');
        return;
      }
      editMode = !editMode;
      document.getElementById('editToggle').textContent =
        editMode ? 'üö´ Disable Edit Mode' : '‚úèÔ∏è Enable Edit Mode';
      loadInventory();
    }

    async function loadInventory() {
      const res = await fetch('/inventory-status');
      const data = await res.json();
      const tbody = document.querySelector('#inventoryTable tbody');
      const filter = document.getElementById('warehouseFilter').value;

      let warehouses = new Set();
      tbody.innerHTML = '';

      data.forEach(item => {
        warehouses.add(item.warehouse_name);

        const isVisible =
          userRole === 'admin'
            ? !filter || item.warehouse_name === filter
            : item.warehouse_name === assignedWarehouse;

        if (isVisible) {
          const tr = document.createElement('tr');
          const cssClass = ['green', 'orange', 'red'].includes(item.status)
            ? item.status
            : 'unknown';
          tr.classList.add(cssClass);

          let statusIcon = '';
          switch (item.status) {
            case 'green': statusIcon = '‚úÖ'; break;
            case 'orange': statusIcon = '‚ö†Ô∏è'; break;
            case 'red': statusIcon = '‚ùå'; break;
            default: statusIcon = '‚ùì';
          }

          tr.innerHTML = `
            <td>${item.warehouse_name}</td>
            <td>${item.item_id}</td>
            <td contenteditable="${editMode}" data-field="name">${item.name}</td>
            <td contenteditable="${editMode}" data-field="quantity">${item.quantity}</td>
            <td>${statusIcon}</td>
            ${editMode ? '<td><button onclick="saveItem(this)">üíæ Save</button></td>' : ''}
          `;
          tbody.appendChild(tr);
        }
      });

      if (userRole === 'admin') {
        const warehouseSelect = document.getElementById('warehouseFilter');
        warehouseSelect.innerHTML = '<option value="">All</option>';
        [...warehouses].forEach(w => {
          warehouseSelect.innerHTML += `<option value="${w}">${w}</option>`;
        });
      }
    }

    async function saveItem(btn) {
      if (userRole !== 'admin') {
        alert('‚ùå Only admin can edit items.');
        return;
      }

      const row = btn.closest('tr');
      const warehouse = row.children[0].textContent.trim();
      const item_id = row.children[1].textContent.trim();
      const name = row.querySelector('[data-field="name"]').textContent.trim();
      const quantity = parseInt(row.querySelector('[data-field="quantity"]').textContent.trim());

      const res = await fetch('/update-item', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ warehouse, item_id, name, quantity })
      });

      const result = await res.json();
      if (result.success) {
        btn.disabled = true;
        btn.textContent = '‚úîÔ∏è Saved';
        setTimeout(() => {
          btn.disabled = false;
          btn.textContent = 'üíæ Save';
          loadInventory();
        }, 1000);
      } else {
        alert('‚ùå Update failed: ' + result.message);
      }
    }

    function exportInventory() {
      window.location.href = '/export-inventory';
    }

    function openChartModal() {
      document.getElementById('chartModal').style.display = 'block';
    }

    function closeChartModal() {
      document.getElementById('chartModal').style.display = 'none';
    }

    function showCreateWarehouse() {
      document.getElementById('createWarehouseContainer').style.display = 'block';
    }

    async function saveWarehouse() {
      const name = document.getElementById('newWarehouseInput').value.trim();
      if (!name) return alert('Please enter a warehouse name.');
      const res = await fetch('/add-warehouse', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ name })
      });
      const data = await res.json();
      if (data.success) {
        alert('‚úÖ Warehouse added successfully.');
        document.getElementById('createWarehouseContainer').style.display = 'none';
        document.getElementById('newWarehouseInput').value = '';
        loadInventory();
      } else {
        alert('‚ùå Failed to add warehouse.');
      }
    }

    document.getElementById('warehouseFilter').addEventListener('change', loadInventory);
    setInterval(loadInventory, 30000);
    checkSession();
  </script>
</body>
</html>
